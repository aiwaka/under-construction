---
title: リニューアルの続き
description: "画像の最適化とかについての備忘録"
thumbnail:
  type: local
  filename: blue_square
  format: png
date: 2023-03-11
tags:
  - "プログラミング"
  - "Astro"
---

import BlogImagesList from "@components/blog/BlogImagesList.astro";

## 概要

[前回の記事](https://aiwaka.github.io/under-construction/blog/20230310-renewal)に引き続き、主にパフォーマンスを上げることを目的にチューニングをそれなりに行いました。
一連の更新で行った作業を備忘録的に残しておこうと思います。

## Gitリポジトリのアーカイブ

もともとSvelteKitで作っていましたが、いきなり使ったこともないAstroに基盤を置き換える勇気はなかったため、別リポジトリで構築を始めました。
その後リニューアルの目処がたったわけですが、両方の履歴を残したいと思いました。
このために、既存のブランチは名前を変更し、新しく作業していたリポジトリのブランチを元のリポジトリに取り込むということをします。

### リモートリポジトリのリネーム

これについては[公式ページ](https://docs.github.com/ja/repositories/configuring-branches-and-merges-in-your-repository/managing-branches-in-your-repository/renaming-a-branch)が存在します.
GitHub上のブランチ名を変更した後以下のコマンドを実行せよとあります。

```bash
git branch -m OLD-BRANCH-NAME NEW-BRANCH-NAME
git fetch origin
git branch -u origin/NEW-BRANCH-NAME NEW-BRANCH-NAME
git remote set-head origin -a
```

このため、`main`や`develop`に`old-svelte/`という接頭辞をつけ、一連の操作を実行しました。
これは、ローカルで名前を変更し、リモートの名前変更を読み込み、トラッキングブランチを新しく設定し直し、リモートのデフォルトブランチを書き換える、という流れ（のはず）です。
この後、不要になったトラッキングブランチを削除するため

```bash
git remote prune origin
```

を実行します。
以上でブランチ名の変更及びアーカイブは終わりです。

あまりよくわからずにすべてのブランチ名を変更しましたが、よく考えるとすべて旧`main`にマージしているに決まっているので`main`だけ残せばよかったと思います。
というか折を見て消します。
（そもそもGitの性質上残す必要はないのですが。移行に不安があったのと、なんとなくやってみたかったという色が濃いです。）

### 新リポジトリの取り込み

今回は[このページ](https://qiita.com/uasi/items/77d41698630fef012f82)を参考にしました。

リモートリポジトリとしてローカルの別リポジトリを登録します。
そしてそのリモートの情報を`fetch`し、そのリモートの`main`ブランチを旧リポジトリ（メインリポジトリ）にマージします。
このとき、`--allow-unrelated-histories`というフラグをつけることで、過去に共通するコミットが一切無いブランチでもマージできるようになるということです（[参考](https://38fanjia.hatenablog.com/entry/2021/03/03/182752)）。
これで新しい`main`ブランチを作成できました。

### 微調整

現段階でGitHub上では旧`main`ブランチを単に`old-svelte/main`に変更したためこれをデフォルトブランチとしています。
これを新しい`main`に直します。
リンクが崩れたりするけどしらんで？と聞いてきますがしょうがないのでそうします。

また、おそらくリモートリポジトリを複数追加した影響と思いますが、リポジトリのコンフィグが崩れて`origin`と情報をうまくやりとりできなくなりました。
[このページ](https://www.rough-and-cheap.jp/linux/git-remote-branch-not-show/)を参考に、`main`以外のブランチも`origin`を参照するように設定を書き換えると解決しました。

```bash
git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
```

を実行してコンフィグを書き換えます。
これでリポジトリの移行は完了です。

## OGP設定・メタタグ設定

このAstroプロジェクトではレイアウトを使っています。
Svelteと似たようなことをAstroでやるために`head`タグの中にスロットを入れ、好きなメタ情報を渡すことができるようにしています。
ここでOGP設定を行い、基本レイアウトではフォールバックを用意し、ブログページレイアウトではOGPの明示を必須にするというようにしました。

また、`meta`タグを設定してSEO配慮を多少してみました。

## JavaScriptの排除

jsをゼロにしようというのがAstroのコンセプトです。
SvelteなどのUIフレームワークを使うことでインタラクティブな要素を使うことができますが、これもあまりうれしくないということです。
以前の構成でJavaScriptを使って動的にしていた要素があったのですが、ちょっと工夫すればCSSのメディアクエリだけで実現できることに気づきました。
具体的にはページ移動用のアニメーションするリンクですが、この高さを画面の大きさ依存で変更するという処理をSvelteのリアクティブ変数に任せてしまっていました。
高さという属性を画面の大きさで変化させるのはCSSだけでできるという普通すぎることに気づかなかったのは反省です。
他にも言語などのアイコンの大きさは変化するようにしていたのですが、そもそもフォントサイズが変化するため意味がないと考えて省きました。
結局クライアントで動くスクリプトを一切排除できました。

## 画像の最適化

一番頑張ってみた部分です。
特に最初のページのアイコンなど、凄まじいサイズの画像をそのまま読み込ませていたので色々最悪でした（今までご迷惑をおかけしました）。
Astroは公式で`@astrojs/image`というプラグインがあるようなので、これを使って画像変換や最適化を行うことにしました。

ところがこれがなかなか曲者で、様々な仕様に悩まされました。
無知なところが大きかったのですが概ね次のような感じです。

- 画像の所在が`public`以下か`src`以下かで設定できる、また必要な属性が変化する。
- `src`以下の場合ソースとして`import`が使えるが、これはViteの組み込み機能であるため関数に切り出すことができない。
- `quality`というパラメータが取れる値の範囲を書いていない（結局`0`から`100`のようです）。
- 画像先読みのために`getImage`という関数を使って変換先のURLを取得しようとしたが、HTML中のカスタム要素と同じパラメータを引数に設定しても違うURLが返ってくるため先読みに使えなかった（Issueで似たようなことを言っている人もいたが解決策はよくわからなかった。つい最近のAstroの実験機能で追加された画像機能の組み込み統合ではその辺りの用途でのコードの全体がドキュメントに記載されている）。
- 画像アスペクト比は基本的に事前に指定するしか無いため、CSS側でうまく吸収する必要がある。
- `base`の文字列を使うべきか使わないべきかが異なることがあり難しい。

...まあ無知によるところが大きいですが。
`.webp`や`.avif`の存在を知ったり、レスポンシブ画像について調べたりして学ぶところは大いにありました。
設定後はビルド時に画像が変換されるようになったため、読み込む容量が極めて小さくなっています。

この最適化ですべての画像に`loading='lazy'`が追加されるのですが、パフォーマンスに配慮し、最初の黒い画像だけは

```html
loading='eager' fetchpriority='high'
```

を設定しています。
これで読み込んでから画像が表示されるまでの時間が短くなる効果があると思います。

（20230313追記）完全に忘れていたのですが、言語やサービスのアイコンもSVGですが画像でした。
これも最適化しようと思いましたが、変換等は一切必要ない上に余計なことをされると面倒なので、単に`loading='lazy'`を`img`タグに追加しました。
これだけでブロッキングタイムが減ったようです。
（追記終わり）

## （20230313追記）Partytownを利用してGoogle Analyticsを埋め込む

せっかくなので分析を入れてみます。
基本はスクリプトを埋め込むだけのはずですが、Astroのことなのでうまくやる方法があるかもと思い検索したところやはりありました。
Partytownというプロジェクト（？）があるらしく、サードパーティ製のスクリプトをメインスレッドの外で読み込んだり実行したりするのを簡単にしてくれるものだそうです。
これをAstroに簡単に統合できます（なんでこんなに手広くインテグレーションがあるのかと思いますが、そういうものを組み込みやすい設計が画期的なのかなとも思います）。

```bash
npx astro add partytown
```

で入れると設定ファイルも書き換えてくれます。
このときにこのように書き換えますよというのをちゃんと表示してくれるのもひたすらポイントが高いです。
Partytownというものをさっき初めて知っただけで何ができるかしか知りませんが、したいことをするだけなので気にせずに使います。
最も基底になるレイアウトファイルのヘッダにGAのタグを埋め込み、

```html
<script
  type="text/partytown"
  async
  src="https://www.googletagmanager.com/gtag/js?id=G-XRK0L39370"
></script>
```

のように`type`を設定します。
これだけでワーカースレッドで実行してくれるようになるらしい。
アナリティクスの設定はこれで完了です。

## その他旧サイトから変わったところ

[私の技術を載せているところ](https://aiwaka.github.io/under-construction/#skill)で、以前は技術名やアイコンと説明が必ず横並びになっていましたが、現在はモバイルではアイコンが上に回り込むようになって文章が格段に読みやすくなりました。

また現在は表示されていませんが、9記事以上はページ分割されるようになっています。
ひっそりとそのためのコンポーネントが追加されています。

また、ブログ記事のマークダウンでLaTeXを使うフラグを明示的に立てないと`katex`のCSSが読み込まれないように変更しました。
これもパフォーマンス戦略の一環です。
先程取り上げた`head`タグ内へのスロットを利用しています。

## まとめ

以上の感じで、このウェブサイトはとても新しくなりました。
パフォーマンス分析してみたところ、PC画面ではこのようになりました。

<BlogImagesList
  images={{
    src: "20220312-performance.jpeg",
    width: 1998,
    alt: "パフォーマンス分析結果",
    quality: 70,
  }}
/>

これはめでたい。
モバイル版ではなぜかかなりパフォーマンスが落ちてしまいます...が、それほど使ってみた感じで問題はなかったです。
他のサイトのものも見てみましたがそれほど変わりはないという感じでした。

（20230313追記）
この追記部分の変更後、試しに計測してみたところモバイル版も安定領域に入りました。

<BlogImagesList
  images={{
    src: "20220313-mobile-performance.jpeg",
    width: 1998,
    alt: "パフォーマンス分析結果",
    quality: 70,
  }}
/>

めでたい。
（追記終わり）

Svelteでは少し難儀しそうだった目次の表示とかもできそうな気がしています。
いろいろ触って遊んでみたいと思います。
