---
title: 画像処理ユーティリティを作りました
description: 意外と苦労した
thumbnail:
  type: remote
date: 2023-11-29T16:00:00
tags:
  - Rust
  - プログラミング
  - 画像処理
---

export const ARTICLE_ID = "20231129-image-utilities";
import BlogImagesRemote from "@components/blog/BlogImagesRemote.astro";

## 概要

[以前書いた記事](./20231011-image-processing)で、色々なツールを使って画像処理をやっていることを書きました。
これはこれで良いのですが、やっぱり何回もスクリプト処理を実行するのは面倒なものです。
しかも、ToyViewerはAppStore経由で入手することになりますが、今使っている借り物のPCでログインしたくありません。
というわけでぼかしをかけられないという自体になってしまったため、いっそ自分用の画像処理ソフトウェアを作ってしまおうと思いました。

## 作ったもの

フィルタをかけられるソフトと、画像を圧縮するソフトにわけて作りました。

### フィルタ

リポジトリは<a href="https://github.com/aiwaka/my-img-utilities" target="_blank" noreferrer noopener>こちら</a>です。
対話的プロンプトでフィルタの種類や範囲（矩形）を指定し、一括でフィルタをかけてJPEGファイルとして保存します。
HEIC形式含む画像を処理できます。

前の記事でも紹介したKuwaharaフィルタがかなりマイナーで、しかし実装も簡単なのでこれを最優先に作りました。
というかこれを使うというモチベーションがなければRustで実装などしていません（ガウスぼかしはGIMPにもあるので）。
うまくかかるように作れて満足です。

<BlogImagesRemote
baseName={ARTICLE_ID}
images={[
{ name: "original", width: 1200, caption: "処理前" },
{ name: "operated", width: 1200, caption: "Kuwaharaフィルタで全体を処理" },
]}
/>

矩形の指定が必要な点が非常に良くないです。
が、これを外すためにはGUIが必要になり極めて面倒です（Tauriも試しましたが時間と気力が足りず...）。
なので、簡単に入手できるGIMPで処理したい矩形の範囲だけ人力で見て、それを使うことにしました。
フィルタ処理や変換をコマンドで行えるのでこれだけでも便利に使えています（今のところ）。
顔認識とかできたらかっこいいなあ...とか思ってますが多分やりません。

### 圧縮

リポジトリは<a href="https://github.com/aiwaka/image-converter" target="_blank" noreferrer noopener>こちら</a>です。
圧縮クオリティとリサイズ倍率を指定してWebP形式画像に変換できます。
変換先を選べるようにもしたかったですが面倒だったので必要なものだけ実装しました。
内部ではImagemagick、Mozjpegを利用し、RustのwebpクレートでWebPにエンコードしています。
Imagemagickの依存性を取れれば万々歳でしたが、ちょっと力が足りませんでした。
そのため、HEIC形式画像を変換するためにシステム上にImagemagickが必要になっています。

また、`rayon`クレートを用いて簡単ではありますが並列化していますので、単にシェルを使うよりかなり高速に変換できます。

## 余談

iPhoneで撮影した画像にはDisplay P3形式のICCプロファイルが埋め込まれています。
MagickのstripでEXIF情報をすべて取り払うと、このプロファイルも消え、青色が赤みがかってしまうという問題に直面。
色空間？ICC？というレベルで知識がなかったためこれを解決するのにかなりの苦労を要しました。
結局、各圧縮段階でICCを保持する方法を探し、それぞれで実装することになりました。

### Imagemagick

<a href="https://blog.awm.jp/2017/06/11/imicc/" target="_blank" noreferrer noopener>このページ</a>が参考になりました。
`profile`を操作する際に`!`をつけると保持できるとのこと。
どこに書いてあるんだ...？

RustではmagickのAPIをCで呼び出せるMagickWandをラップしたものが開発されているため、これを使い、以下のようにプロファイル操作を指定できます。

```rust
wand.profile_image("!icc,*", None)?;
```

Cのバインドで実装しているクレートは型情報が落ちてしまっているため使うのが難しいですね...。
このメソッドはプロファイル名を指定してバイナリを書き込むか消去できるもののようですが、CLIで指定できる文字列を渡せるようです（確証はなかったですが動作しました）。
この指定でICCを保持し、カメラ情報や位置情報等は消去できます。
プロファイル操作前に`auto_orient`も用いて方向情報も維持するようにしています。

### Mozjpeg

<a href="https://qiita.com/benki/items/b12892fea32e50d2ba77" target="_blank" noreferrer noopener>このページ</a>を参考にしました（`rayon`による並列化もここを見てやりました）。
RustのMozjpegを扱うクレートではEXIFマーカーを扱う構造体が定義されているため、デコード時にこれを保存しておきます。
エンコード後にこれらを書き込むことでマーカーを維持できます。

### webp

<a href="https://docs.rs/img-parts/latest/img_parts/" target="_blank" noreferrer noopener>`img_parts`</a>というクレートを用いて特定形式においてはICCプロファイルを操作できます。
webp周りで利用できたので、手っ取り早くこれを使いました。
ヘッダを読むだけではあるので自分でやっても良かったのですがとにかく動くものを早く作りたかったという事情があります（そもそもこういうことをやっている場合ではない）~~（それならシェルスクリプトでいいじゃんとか言わない）~~。
JPEGバイナリからプロファイルを読み、エンコード後に書き込んで維持します。

## 最後に

ぼかしはかなりいい感じにかかりますし、圧縮も高速な上に一つの実行で済むためストレスが減りました。
中間生成物もなくなったためそれもありがたい。
というか画像処理自体が結構楽しかったのでもう少し色々やってみたい気もします。

