---
title: ブログ内の画像をMicroCMSから取得するようにしました
description: 設定や実装などについて
thumbnail: remote
date: 2023-07-28
tags:
  - Astro
  - プログラミング
  - 運営
draft: true
---

import BlogImageList from "@components/blog/BlogImageList.astro";
import NamedImages from "@components/blog/NamedImages.astro";

export const ARTICLE_ID = "20230728-images-from-cms";

## 背景

ブログを書く上では画像は必須ですが、Gitリポジトリで画像を管理しているといよいよ容量がまずそう、という空気が出てきました。
現時点で70MB強あり、単一リポジトリとしては大きすぎます。
まあGitの仕組みをあまりわからないままバイナリを一度でも含めた自分が悪いのですが。

そこで以前から画像だけ外部化したいと考えていたのですが、うまい方法を中々思いつかずに手つかずのままでした。
最終的に形にはなったのでここに置いておこうと思います。
結局うまい方法とは言い難いですが。。。

そもそも、コンテンツも外部化すればいい気もします。実際私が関わった部活のウェブサイトはコンテンツをCMSのみで管理しています。が、やはり記事は手元においておきたいという私の好みを反映できる環境で好き勝手にやりたいという気持ちをこのウェブサイトに込めています。読者の環境におけるパフォーマンスについては大差ないと思います。

## 方針

### 利用する外部ストレージ

利用するに当たって望ましい条件はまず無料であること、データ形式が明確であることが挙げられます。
APIが整備されているという点も加味してヘッドレスCMSを利用したいと以前から考えていました。
ヘッドレスCMSを謳っているものであれば機能面での過不足はほぼありません（無料という制約をつければ尚更贅沢は言えない）。
その上で他のプロジェクトで利用した経験があったため、microCMSを使うことにしました。
無料枠でも月10GBまで転送でき、メディアストレージは無制限とのことで、不足はなさそうです。

### 画像の利用形式

ブログ記事はMDXで書いているため、Astroコンポーネントを利用できます。
そのため、CMS上でローカルのMDXファイルに対応する記事を作成し、その中で利用したい画像に名前をつけ、コンポーネントの引数でその名前を指定すれば画像を取得できるという形を考えました。
画像をリモートから取得すること自体は絶対にできるはずなので、どこかで名前とURLの対応を行えば良いという方針を立てました。

名前と値の対応といえば所謂Map型のコンテナで、JSONで完全に表現可能です。
Astroは標準でZodを内包しているため、バリデーションも低コストで実装できます。
microCMSから取得したデータを何らかの形で保持し、専用のコンポーネント内でそれを参照して画像URLを取得することができればよいことになります。
実際にはこのビルド時・ランタイムでグローバルな値を保証するというのが最も時間がかかった部分でした。

### 実現手法

Astroはビルド時にコンポーネント間にまたがってグローバルな値を使うことはあまり想定されていないようです。
環境変数を用いることはできるようですが、JSONの文字列という大きなデータを環境変数で扱うのも些か不自然です。

ところで、Astroには様々なインテグレーションが用意されていますが、これらが実際に行っていることはAstroのランタイムやビルド時の特定のタイミングで特定の処理を挿入するということに過ぎないと最近知りました。
ということは、Astroが走るより前にmicroCMSから画像のデータを取得し、適当なJSONファイルがプロジェクト内に存在することを保証すれば、必要になればそのファイルを読むことでグローバルな値を実現できるのではないかと考えました。
このために自前で適当なライブラリを作成しました。

```ts
interface ImagesStorageSchema {
  [title: string]: {
    thumbnail: z.infer<typeof MicroCMSImageSchema>;
    images: {
      [name: string]: z.infer<typeof MicroCMSImageSchema>;
    };
  };
}
```

このようなスキーマを定義してこれに従うJSONをファイルで保存します。
これで、ブログ記事の名前とその中での名前を指定すればURLを取得することができます（`MicroCMSImageSchema`はサムネイルのURLと画像の情報の配列を持ちます）。

次に`NamedImages`というコンポーネントを定義します。
ブログの画像を並べるためのコンポーネントを包んでいるだけなのですが、先程生成したJSONを読んでURLを取得して画像データを生成する処理を行います。
Astroの画像インテグレーションはリモートURLを指定しても問題なく動作するため、既存のものにはほとんど手を加えずに実装できました。

余談というか課題ですが、Astroがビルド時にどのようにスクリプトをバンドルするのか全然把握していないため、JSONを読み込むための相対パスを正しく指定するために時間を書けてしまいました。
色々脆弱だと思うので今後勉強したいところです。

```mdx
<NamedImages
  baseName={ARTICLE_ID}
  images={[
    { name: "test", width: 1000, caption: "alt" },
    { name: "test", width: 1200, alt: "alt", caption: "aaaa" },
  ]}
/>
```

このような形でブログ記事のMDXファイル内で利用すると、以下のように画像が生成されます。
この画像はローカルには存在しませんが、大きさやキャプションも従来と同じように指定できています。

<NamedImages
  baseName={ARTICLE_ID}
  images={[
    { name: "test", width: 1000, caption: "alt" },
    { name: "test", width: 1200, alt: "alt", caption: "aaaa" },
  ]}
/>

ちなみに大きさを指定する際はmicroCMSの画像APIを用いて取得時点で大きさを指定しています。
WEBPに圧縮する際に縮小したほうが綺麗なのかもしれませんが転送量にも一応気を配っておこうという算段です。

```ts
export const ARTICLE_ID = "20230728-images-from-cms";
```

MDXはスクリプトにより変数を作れるので、このような定数を置いておくことで記事名の指定を楽にしています。
コンポーネントの引数への部分適用（カリー化という？）のようなことができればその指定も不要になると思うのですがAstroの仕様に詳しくないためまだ実現できていません。

### エラー対策

記事を編集する上ではネットワークエラーや名前の指定ミス等が考えられます。
特にネットワークエラーでエラー落ちさせているとローカルでの編集がしたいという要件から外れてしまいます。
そのため、自作のインテグレーションにオプションを渡し、明示した場合はすべてのエラーを握りつぶす処理を入れます。

また、リモートのデータを扱うAstroコンポーネントで例外を出さない設計にしました。
なにか取得時に問題があった場合は対応したデータが作成されます。
これによりエラーハンドリングというものが不要になります（要件自体に含まれます）。

## まとめ

以前からやりたかったことがようやく実現しました。
まあもはやサーバー使えよ案件ですがケチなのでダメです。
SSRもなんとなく抵抗があるのでしばらくは静的サイトジェネレーターとしてAstroを使いたいと思います。
現状では改善の余地とかいう生ぬるいものではないですが、構造をいじるたびにディレクトリのスナップショットにより凄まじい勢いでGitレポジトリの容量が増加していくことは防げると思います。

今後ともよろしくお願いいたします。
